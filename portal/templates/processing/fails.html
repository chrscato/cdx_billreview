{% extends "base.html" %}

{% block title %}Processing Fails - Bill Review Portal{% endblock %}

{% block content %}
<div class="container">
    <h1>Failed Processing Documents
        {% if fails_count > 0 %}
        <span class="badge bg-danger ms-2">{{ fails_count }}</span>
        {% endif %}
    </h1>
    <p class="lead">Documents that failed validation during processing</p>
    <hr>

    <!-- Quick filter controls REMOVED -->

    <div class="list-group mt-4" id="bill-list-container">
        <!-- Populated by JavaScript -->
    </div>

    {% if fails_count == 0 %}
        <div class="alert alert-info">
            <i class="fas fa-check-circle me-2"></i>
            No failed processing files found.
            {% if filter_params %}
                (Based on provided filters)
            {% else %}
                 All documents have been processed successfully or moved.
            {% endif %}
        </div>
    {% endif %}
</div>

<!-- Hidden containers for data transfer from server to client -->
<div id="server-bills-data" style="display:none;" data-bills='{{ bills_json | tojson }}'></div>
{% if filter_params %}
<div id="server-filter-params" style="display:none;" data-filters='{{ filter_params | tojson }}'></div>
{% endif %}
{% endblock %}

{% block scripts %}
<!-- Include the view manager script (ensure renderBillList is defined here) -->
<script src="{{ url_for('static', filename='js/failed-bills-view-manager.js') }}"></script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Get bill data from hidden element
    const billsDataElement = document.getElementById('server-bills-data');
    window.BILLS_DATA = billsDataElement ? JSON.parse(billsDataElement.dataset.bills || '[]') : [];
    
    // Get filter parameters from hidden element if available
    const filterParamsElement = document.getElementById('server-filter-params');
    window.SERVER_FILTERS = filterParamsElement ? JSON.parse(filterParamsElement.dataset.filters || '{}') : {};
    
    // Ensure renderBillList exists in failed-bills-view-manager.js
    if (window.renderBillList) {
        window.renderBillList(window.BILLS_DATA);
    } else {
        console.error('renderBillList function not found. Cannot display bills.');
        const container = document.getElementById('bill-list-container');
        if (container) {
            container.innerHTML = '<div class="alert alert-danger">Error: Could not load bill rendering script.</div>';
        }
    }
  });
</script>
{% endblock %}