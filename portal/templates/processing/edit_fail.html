{% extends "base.html" %}

{% block title %}Edit Processing Fail - Bill Review Portal{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex align-items-center">
            <h1 class="mb-0">{{ filename }}</h1>
            <div class="ms-3">
                <span class="badge bg-secondary">{{ current_index }} of {{ total_files }}</span>
                {% if fails_count > 0 %}
                <span class="badge bg-danger ms-2">{{ fails_count }} total</span>
                {% endif %}
            </div>
        </div>
        <div class="d-flex gap-2">
            {% if prev_file %}
            <a href="{{ url_for('processing.view_fail_file', filename=prev_file) }}{% if filter_query %}{{ filter_query }}{% endif %}" 
               class="btn btn-outline-secondary">
                <i class="fas fa-chevron-left me-1"></i>Previous
            </a>
            {% endif %}
            <a href="{{ url_for('processing.list_fail_files') }}{% if filter_query %}{{ filter_query }}{% endif %}" class="btn btn-outline-secondary">
                Back to List
            </a>
            {% if next_file %}
            <a href="{{ url_for('processing.view_fail_file', filename=next_file) }}{% if filter_query %}{{ filter_query }}{% endif %}" 
               class="btn btn-outline-secondary">
                Next<i class="fas fa-chevron-right ms-1"></i>
            </a>
            {% endif %}
            <button id="view-pdf" class="btn btn-outline-primary">
                <i class="fas fa-file-pdf me-1"></i>View PDF
            </button>
            <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#escalateModal">
                <i class="fas fa-exclamation-triangle me-1"></i>Escalate
            </button>
            <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#denyModal">
                <i class="fas fa-ban me-1"></i>Deny Bill
            </button>
        </div>
    </div>

    <!-- Validation Information Section -->
    <div class="mb-4">
        <div class="card mb-3">
            <div class="card-header bg-danger text-white">
                <h3 class="card-title mb-0">Validation Failures</h3>
            </div>
            <div class="card-body">
                <ul class="list-group">
                    {% for reason in json_data.validation_info.failure_reasons %}
                        <li class="list-group-item list-group-item-danger">{{ reason }}</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>

    <form method="POST" action="{{ url_for('processing.submit_fail_file', filename=filename) }}">
        <!-- Add hidden field for filter parameters -->
        {% if filter_params %}
        <input type="hidden" name="filter_params" value="{{ filter_params|tojson }}">
        {% endif %}
        
        <div class="row">
            <!-- LEFT SIDE: HCFA Data -->
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h3 class="card-title mb-0">HCFA Information</h3>
                    </div>
                    <div class="card-body">
                        <!-- Patient Info Section -->
                        <div class="mb-4">
                            <h4>Patient Information</h4>
                            <div class="row g-3">
                                <div class="col-md-12">
                                    <label class="form-label">Patient Name</label>
                                    <input type="text" class="form-control" name="patient_info[patient_name]" 
                                           value="{{ json_data.patient_info.patient_name }}" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Date of Birth</label>
                                    <input type="text" class="form-control" name="patient_info[patient_dob]" 
                                           value="{{ json_data.patient_info.patient_dob }}" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">ZIP Code</label>
                                    <input type="text" class="form-control" name="patient_info[patient_zip]" 
                                           value="{{ json_data.patient_info.patient_zip }}" readonly>
                                </div>
                            </div>
                        </div>

                        <!-- Billing Info Section -->
                        <div class="mb-4">
                            <h4>Billing Information</h4>
                            <div class="row g-3">
                                <div class="col-md-12">
                                    <label class="form-label">Provider Name</label>
                                    <input type="text" class="form-control" name="billing_info[billing_provider_name]" 
                                           value="{{ json_data.billing_info.billing_provider_name }}" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Provider NPI</label>
                                    <input type="text" class="form-control" name="billing_info[billing_provider_npi]" 
                                           value="{{ json_data.billing_info.billing_provider_npi }}" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Provider TIN</label>
                                    <input type="text" class="form-control" name="billing_info[billing_provider_tin]" 
                                           value="{{ json_data.billing_info.billing_provider_tin }}" readonly>
                                </div>
                                <div class="col-md-12">
                                    <label class="form-label">Provider Address</label>
                                    <input type="text" class="form-control" name="billing_info[billing_provider_address]" 
                                           value="{{ json_data.billing_info.billing_provider_address }}" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Account Number</label>
                                    <input type="text" class="form-control" name="billing_info[patient_account_no]" 
                                           value="{{ json_data.billing_info.patient_account_no }}" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Total Charge</label>
                                    <input type="text" class="form-control" name="billing_info[total_charge]" 
                                           value="{{ json_data.billing_info.total_charge }}" readonly>
                                </div>
                            </div>
                        </div>

                        <!-- Service Lines Section -->
                        <div class="mb-4">
                            <h4>Service Lines</h4>
                            <div id="hcfa-service-lines">
                                {% for line in json_data.service_lines %}
                                <div class="service-line border rounded p-3 mb-3" data-index="{{ loop.index0 }}">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">CPT Code</label>
                                            <input type="text" class="form-control" 
                                                   name="service_lines[{{ loop.index0 }}][cpt_code]" 
                                                   value="{{ line.cpt_code }}">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Charge Amount</label>
                                            <input type="text" class="form-control" 
                                                   name="service_lines[{{ loop.index0 }}][charge_amount]" 
                                                   value="{{ line.charge_amount }}">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Date of Service</label>
                                            <input type="text" class="form-control" 
                                                   name="service_lines[{{ loop.index0 }}][date_of_service]" 
                                                   value="{{ line.date_of_service }}" readonly>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Units</label>
                                            <input type="text" class="form-control" 
                                                   name="service_lines[{{ loop.index0 }}][units]" 
                                                   value="{{ line.units }}">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Place of Service</label>
                                            <input type="text" class="form-control" 
                                                   name="service_lines[{{ loop.index0 }}][place_of_service]" 
                                                   value="{{ line.place_of_service }}" readonly>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Diagnosis</label>
                                            <input type="text" class="form-control" 
                                                   name="service_lines[{{ loop.index0 }}][diagnosis_pointer]" 
                                                   value="{{ line.diagnosis_pointer }}" readonly>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Modifiers</label>
                                            <input type="text" class="form-control" 
                                                   name="service_lines[{{ loop.index0 }}][modifiers]" 
                                                   value="{{ line.modifiers|join(',') if line.modifiers else '' }}">
                                        </div>
                                        <div class="col-md-8">
                                            <label class="form-label">Procedure Description</label>
                                            <input type="text" class="form-control" 
                                                   value="{{ line.proc_desc }}" readonly>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Category</label>
                                            <input type="text" class="form-control" 
                                                   value="{{ line.category }}" readonly>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Mapping Info Section -->
                        <div class="mb-4">
                            <h4>Mapping Information</h4>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Order ID</label>
                                    <input type="text" class="form-control" value="{{ json_data.mapping_info.order_id }}" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">FileMaker Number</label>
                                    <input type="text" class="form-control" value="{{ json_data.mapping_info.filemaker_number }}" readonly>
                                </div>
                                <div class="col-md-12">
                                    <label class="form-label">Mapping Date</label>
                                    <input type="text" class="form-control" value="{{ json_data.mapping_info.mapping_date }}" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT SIDE: FileMaker Data -->
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h3 class="card-title mb-0">FileMaker Information</h3>
                    </div>
                    <div class="card-body">
                        <!-- Order Section -->
                        <div class="mb-4">
                            <h4>Order Details</h4>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Order ID</label>
                                    <input type="text" class="form-control" value="{{ json_data.filemaker.order.Order_ID }}" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">FileMaker Record Number</label>
                                    <input type="text" class="form-control" value="{{ json_data.filemaker.order.FileMaker_Record_Number }}" readonly>
                                </div>
                                <div class="col-md-8">
                                    <label class="form-label">Patient Name</label>
                                    <input type="text" class="form-control" value="{{ json_data.filemaker.order.PatientName }}" readonly>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Date of Birth</label>
                                    <input type="text" class="form-control" value="{{ json_data.filemaker.order.Patient_DOB }}" readonly>
                                </div>
                                <div class="col-md-12">
                                    <label class="form-label">Address</label>
                                    <input type="text" class="form-control" value="{{ json_data.filemaker.order.Patient_Address }}" readonly>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">City</label>
                                    <input type="text" class="form-control" value="{{ json_data.filemaker.order.Patient_City }}" readonly>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">State</label>
                                    <input type="text" class="form-control" value="{{ json_data.filemaker.order.Patient_State }}" readonly>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">ZIP Code</label>
                                    <input type="text" class="form-control" value="{{ json_data.filemaker.order.Patient_Zip }}" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Assigning Company</label>
                                    <input type="text" class="form-control" value="{{ json_data.filemaker.order.Assigning_Company }}" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Assigning Adjuster</label>
                                    <input type="text" class="form-control" value="{{ json_data.filemaker.order.Assigning_Adjuster }}" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Claim Number</label>
                                    <input type="text" class="form-control" value="{{ json_data.filemaker.order.Claim_Number }}" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Order Type</label>
                                    <input type="text" class="form-control" value="{{ json_data.filemaker.order.Order_Type }}" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Jurisdiction State</label>
                                    <input type="text" class="form-control" value="{{ json_data.filemaker.order.Jurisdiction_State }}" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Bundle Type</label>
                                    <input type="text" class="form-control" value="{{ json_data.filemaker.order.bundle_type|default('None') }}" readonly>
                                </div>
                            </div>
                        </div>

                        <!-- Line Items Section -->
                        <div class="mb-4">
                            <h4>Line Items</h4>
                            <div id="filemaker-line-items">
                                {% for line in json_data.filemaker.line_items %}
                                <div class="line-item border rounded p-3 mb-3" data-index="{{ loop.index0 }}">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">CPT Code</label>
                                            <input type="text" class="form-control" value="{{ line.CPT }}" readonly>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Charge Amount</label>
                                            <input type="text" class="form-control" value="${{ line.Charge }}" readonly>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Date of Service</label>
                                            <input type="text" class="form-control" value="{{ line.DOS }}" readonly>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Units</label>
                                            <input type="text" class="form-control" value="{{ line.Units }}" readonly>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Modifier</label>
                                            <input type="text" class="form-control" value="{{ line.Modifier }}" readonly>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Line Number</label>
                                            <input type="text" class="form-control" value="{{ line.line_number }}" readonly>
                                        </div>
                                        <div class="col-md-8">
                                            <label class="form-label">Procedure Description</label>
                                            <input type="text" class="form-control" value="{{ line.proc_desc }}" readonly>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Category</label>
                                            <input type="text" class="form-control" value="{{ line.category }}" readonly>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Provider Section -->
                        <div class="mb-4">
                            <h4>Provider Details</h4>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Billing Name</label>
                                    <input type="text" class="form-control" value="{{ json_data.filemaker.provider['Billing Name'] }}" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">DBA Name</label>
                                    <input type="text" class="form-control" value="{{ json_data.filemaker.provider['DBA Name Billing Name'] }}" readonly>
                                </div>
                                <div class="col-md-12">
                                    <label class="form-label">Address</label>
                                    <input type="text" class="form-control" value="{{ json_data.filemaker.provider['Address 1 Full'] }}" readonly>
                                </div>
                                <div class="col-md-12">
                                    <label class="form-label">Billing Address</label>
                                    <input type="text" class="form-control" value="{{ json_data.filemaker.provider['Billing Address 1'] }}" readonly>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Billing City</label>
                                    <input type="text" class="form-control" value="{{ json_data.filemaker.provider['Billing Address City'] }}" readonly>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Billing State</label>
                                    <input type="text" class="form-control" value="{{ json_data.filemaker.provider['Billing Address State'] }}" readonly>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Billing ZIP</label>
                                    <input type="text" class="form-control" value="{{ json_data.filemaker.provider['Billing Address Postal Code'] }}" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">TIN</label>
                                    <input type="text" class="form-control" value="{{ json_data.filemaker.provider.TIN }}" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">NPI</label>
                                    <input type="text" class="form-control" value="{{ json_data.filemaker.provider.NPI }}" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Phone</label>
                                    <input type="text" class="form-control" value="{{ json_data.filemaker.provider.Phone }}" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Fax</label>
                                    <input type="text" class="form-control" value="{{ json_data.filemaker.provider['Fax Number'] }}" readonly>
                                </div>
                                <div class="col-md-6">
                                    <input type="text" class="form-control" value="{{ json_data.filemaker.provider.Provider_Network }}" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Provider Type</label>
                                    <input type="text" class="form-control" value="{{ json_data.filemaker.provider.Provider_Type }}" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Provider Status</label>
                                    <input type="text" class="form-control" value="{{ json_data.filemaker.provider.Provider_Status }}" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Need OTA</label>
                                    <input type="text" class="form-control" value="{{ json_data.filemaker.provider.Need_OTA|default('None') }}" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-4">
            <input type="hidden" name="action" id="form-action" value="save">
            <button type="submit" class="btn btn-primary me-2" onclick="document.getElementById('form-action').value='save'">
                Save Changes
            </button>
            <button type="button" class="btn btn-success me-2" onclick="confirmMoveToStaging()">
                <i class="fas fa-arrow-up me-1"></i>Move to Staging
            </button>
            <button type="button" class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#rateAssignmentModal">
                {% if json_data.filemaker.provider['Provider Network'] == 'In Network' %}
                Assign PPO Rates
                {% else %}
                Create OTA (Individual)
                {% endif %}
            </button>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#readyForProcessModal">
                <i class="fas fa-check-circle me-1"></i>Move to Ready for Process
            </button>
        </div>
    </form>

    <!-- Rate Assignment Modal -->
    <div class="modal fade" id="rateAssignmentModal" tabindex="-1" aria-labelledby="rateAssignmentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title" id="rateAssignmentModalLabel">
                        {% if json_data.filemaker.provider['Provider Network'] == 'In Network' %}
                        In Network Rate Assignment
                        {% else %}
                        Out of Network Rate Assignment (OTA) - Individual Rates
                        {% endif %}
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="rateAssignmentForm" action="{{ url_for('processing.assign_rates', filename=filename) }}" method="POST">
                        <!-- Hidden data fields for JS access -->
                        <input type="hidden" id="filename" value="{{ filename }}">
                        <input type="hidden" id="clean-tin" value="{{ json_data.filemaker.provider.TIN|replace('-', '') }}">
                        <input type="hidden" id="provider-network" value="{{ json_data.filemaker.provider['Provider Network'] }}">
                        
                        <!-- Add hidden field for filter parameters -->
                        {% if filter_params %}
                        <input type="hidden" name="filter_params" value="{{ filter_params|tojson }}">
                        {% endif %}
                        
                        {% if json_data.filemaker.provider['Provider Network'] == 'In Network' %}
                        <div class="alert alert-info">
                            <strong>In Network Rate Assignment:</strong> This will update the PPO table with the rates you provide for this provider's TIN.
                        </div>
                        {% else %}
                        <div class="alert alert-warning">
                            <strong>OTA Rate Assignment:</strong> This will create an OTA record for this provider/CPT combination. OTA cases only support individual rate corrections.
                        </div>
                        {% endif %}
                        
                        <h5 class="mt-3">Provider Information</h5>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Provider Name</label>
                                <input type="text" class="form-control" value="{{ json_data.filemaker.provider['Billing Name'] }}" readonly>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">TIN</label>
                                <input type="text" class="form-control" value="{{ json_data.filemaker.provider.TIN }}" readonly>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Network Status</label>
                                <input type="text" class="form-control" value="{{ json_data.filemaker.provider['Provider Network'] }}" readonly>
                            </div>
                        </div>

                        <!-- Tabs Navigation -->
                        <ul class="nav nav-tabs mb-3" id="rateAssignmentTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="individual-rates-tab" data-bs-toggle="tab" 
                                        data-bs-target="#individual-rates" type="button" role="tab" 
                                        aria-controls="individual-rates" aria-selected="true">
                                    Individual CPT Rates
                                </button>
                            </li>
                            {% if json_data.filemaker.provider['Provider Network'] == 'In Network' %}
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="category-rates-tab" data-bs-toggle="tab" 
                                        data-bs-target="#category-rates" type="button" role="tab" 
                                        aria-controls="category-rates" aria-selected="false">
                                    Category Rates
                                </button>
                            </li>
                            {% endif %}
                        </ul>

                        <!-- Tabs Content -->
                        <div class="tab-content" id="rateAssignmentTabContent">
                            <!-- Individual CPT Rates Tab -->
                            <div class="tab-pane fade show active" id="individual-rates" role="tabpanel" 
                                 aria-labelledby="individual-rates-tab">
                                <h5 class="mt-3">Missing Rate CPT Codes</h5>
                                <div class="table-responsive">
                                    <table class="table table-bordered">
                                        <thead>
                                            <tr>
                                                <th>CPT Code</th>
                                                <th>Modifier</th>
                                                <th>Billed Amount</th>
                                                <th>Assigned Rate</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for reason in json_data.validation_info.failure_reasons %}
                                                {% if reason.startswith('RATE_MISSING:') %}
                                                    {% set cpt_code = reason.split(':')[1].strip() %}
                                                    {% for line in json_data.service_lines %}
                                                        {% if line.cpt_code == cpt_code %}
                                                            <tr data-cpt-code="{{ line.cpt_code }}">
                                                                <td>{{ line.cpt_code }}</td>
                                                                <td>
                                                                    {% set mod = '' %}
                                                                    {% for m in line.modifiers %}
                                                                        {% if m == '26' or m == 'TC' %}
                                                                            {% set mod = m %}
                                                                        {% endif %}
                                                                    {% endfor %}
                                                                    <input type="hidden" name="modifier-{{ line.cpt_code }}" value="{{ mod }}">
                                                                    {{ mod }}
                                                                </td>
                                                                <td>{{ line.charge_amount }}</td>
                                                                <td>
                                                                    <div class="input-group">
                                                                        <span class="input-group-text">$</span>
                                                                        <input type="number" step="0.01" class="form-control" 
                                                                               id="rate-input-{{ line.cpt_code }}"
                                                                               name="rate" 
                                                                               placeholder="Enter rate" required>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        {% endif %}
                                                    {% endfor %}
                                                {% endif %}
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Category Rates Tab -->
                            <div class="tab-pane fade" id="category-rates" role="tabpanel" 
                                 aria-labelledby="category-rates-tab">
                                <div class="row g-3">
                                    <!-- MRI Categories -->
                                    <div class="col-md-12">
                                        <h6 class="mb-3">MRI Categories</h6>
                                        <div class="row g-3">
                                            <div class="col-md-4">
                                                <div class="form-check mb-2">
                                                    <input class="form-check-input" type="checkbox" id="mri-wo-enabled" 
                                                           name="category_enabled[mri_wo]">
                                                    <label class="form-check-label" for="mri-wo-enabled">
                                                        MRI w/o
                                                    </label>
                                                </div>
                                                <div class="input-group">
                                                    <span class="input-group-text">$</span>
                                                    <input type="number" step="0.01" class="form-control" 
                                                           id="rate-mri-wo" name="category_rate[mri_wo]" 
                                                           placeholder="Enter rate">
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-check mb-2">
                                                    <input class="form-check-input" type="checkbox" id="mri-w-enabled" 
                                                           name="category_enabled[mri_w]">
                                                    <label class="form-check-label" for="mri-w-enabled">
                                                        MRI w/
                                                    </label>
                                                </div>
                                                <div class="input-group">
                                                    <span class="input-group-text">$</span>
                                                    <input type="number" step="0.01" class="form-control" 
                                                           id="rate-mri-w" name="category_rate[mri_w]" 
                                                           placeholder="Enter rate">
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-check mb-2">
                                                    <input class="form-check-input" type="checkbox" id="mri-wwo-enabled" 
                                                           name="category_enabled[mri_wwo]">
                                                    <label class="form-check-label" for="mri-wwo-enabled">
                                                        MRI w/&w/o
                                                    </label>
                                                </div>
                                                <div class="input-group">
                                                    <span class="input-group-text">$</span>
                                                    <input type="number" step="0.01" class="form-control" 
                                                           id="rate-mri-wwo" name="category_rate[mri_wwo]" 
                                                           placeholder="Enter rate">
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- CT Categories -->
                                    <div class="col-md-12">
                                        <h6 class="mb-3">CT Categories</h6>
                                        <div class="row g-3">
                                            <div class="col-md-4">
                                                <div class="form-check mb-2">
                                                    <input class="form-check-input" type="checkbox" id="ct-wo-enabled" 
                                                           name="category_enabled[ct_wo]">
                                                    <label class="form-check-label" for="ct-wo-enabled">
                                                        CT w/o
                                                    </label>
                                                </div>
                                                <div class="input-group">
                                                    <span class="input-group-text">$</span>
                                                    <input type="number" step="0.01" class="form-control" 
                                                           id="rate-ct-wo" name="category_rate[ct_wo]" 
                                                           placeholder="Enter rate">
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-check mb-2">
                                                    <input class="form-check-input" type="checkbox" id="ct-w-enabled" 
                                                           name="category_enabled[ct_w]">
                                                    <label class="form-check-label" for="ct-w-enabled">
                                                        CT w/
                                                    </label>
                                                </div>
                                                <div class="input-group">
                                                    <span class="input-group-text">$</span>
                                                    <input type="number" step="0.01" class="form-control" 
                                                           id="rate-ct-w" name="category_rate[ct_w]" 
                                                           placeholder="Enter rate">
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="form-check mb-2">
                                                    <input class="form-check-input" type="checkbox" id="ct-wwo-enabled" 
                                                           name="category_enabled[ct_wwo]">
                                                    <label class="form-check-label" for="ct-wwo-enabled">
                                                        CT w/&w/o
                                                    </label>
                                                </div>
                                                <div class="input-group">
                                                    <span class="input-group-text">$</span>
                                                    <input type="number" step="0.01" class="form-control" 
                                                           id="rate-ct-wwo" name="category_rate[ct_wwo]" 
                                                           placeholder="Enter rate">
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Other Categories -->
                                    <div class="col-md-12">
                                        <h6 class="mb-3">Other Categories</h6>
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <div class="form-check mb-2">
                                                    <input class="form-check-input" type="checkbox" id="xray-enabled" 
                                                           name="category_enabled[xray]">
                                                    <label class="form-check-label" for="xray-enabled">
                                                        XRAY
                                                    </label>
                                                </div>
                                                <div class="input-group">
                                                    <span class="input-group-text">$</span>
                                                    <input type="number" step="0.01" class="form-control" 
                                                           id="rate-xray" name="category_rate[xray]" 
                                                           placeholder="Enter rate">
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-check mb-2">
                                                    <input class="form-check-input" type="checkbox" id="ultrasound-enabled" 
                                                           name="category_enabled[ultrasound]">
                                                    <label class="form-check-label" for="ultrasound-enabled">
                                                        ULTRASOUND
                                                    </label>
                                                </div>
                                                <div class="input-group">
                                                    <span class="input-group-text">$</span>
                                                    <input type="number" step="0.01" class="form-control" 
                                                           id="rate-ultrasound" name="category_rate[ultrasound]" 
                                                           placeholder="Enter rate">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3 mt-4">
                            <label for="rate-notes" class="form-label">Notes</label>
                            <textarea class="form-control" id="rate-notes" name="notes" rows="3" 
                                      placeholder="Add any notes about this rate assignment"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    {% if json_data.filemaker.provider['Provider Network'] == 'In Network' %}
                    <button type="button" class="btn btn-success" id="assignRatesBtn">Assign Rate & Save</button>
                    {% else %}
                    <button type="button" class="btn btn-warning" id="createOTABtn">Create OTA with Individual Rates</button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Ready For Process Modal -->
    <div class="modal fade" id="readyForProcessModal" tabindex="-1" aria-labelledby="readyForProcessModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="readyForProcessModalLabel">Move to Ready For Process</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="ready-for-process-form" method="POST" action="{{ url_for('processing.move_to_readyforprocess', filename=filename) }}">
                    <div class="modal-body">
                        <!-- Add hidden field for filter parameters -->
                        {% if filter_params %}
                        <input type="hidden" name="filter_params" value="{{ filter_params|tojson }}">
                        {% endif %}
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-1"></i>
                            <strong>Ready For Process Queue</strong>
                            <p class="mb-0 mt-1">This action will move the file to the ready for process queue in S3 (data/hcfa_json/readyforprocess/). The file will be processed by the automated system.</p>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Bill Information</label>
                            <ul class="list-group mb-3">
                                <li class="list-group-item"><strong>Filename:</strong> {{ filename }}</li>
                                <li class="list-group-item"><strong>Provider:</strong> {{ json_data.filemaker.provider['Billing Name']|default(json_data.billing_info.billing_provider_name, true)|default('Unknown Provider', true) }}</li>
                                <li class="list-group-item"><strong>Total Charge:</strong> {{ json_data.billing_info.total_charge|default('N/A', true) }}</li>
                                <li class="list-group-item">
                                    <strong>CPT Codes:</strong> 
                                    {% for line in json_data.service_lines %}
                                        {{ line.cpt_code }}{% if not loop.last %}, {% endif %}
                                    {% else %}
                                        None available
                                    {% endfor %}
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-check-circle me-1"></i>Move to Ready For Process
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize components
        const viewPdfButton = document.getElementById('view-pdf');
        const escalateModal = document.getElementById('escalateModal');
        const escalateForm = document.getElementById('escalate-form');
        const denyModal = document.getElementById('denyModal');
        const denyForm = document.getElementById('deny-form');
        const readyForProcessModal = document.getElementById('readyForProcessModal');
        const readyForProcessForm = document.getElementById('ready-for-process-form');
        const reasonTextarea = document.getElementById('escalate-reason');
        const rateAssignmentForm = document.getElementById('rateAssignmentForm');
        
        // Create Bootstrap modal instances
        const escalateModalInstance = new bootstrap.Modal(escalateModal);
        const denyModalInstance = new bootstrap.Modal(denyModal);
        const readyForProcessModalInstance = new bootstrap.Modal(readyForProcessModal);
        
        // Handle ajax form submission for rate assignment
        const assignRatesBtn = document.getElementById('assignRatesBtn');
        const createOTABtn = document.getElementById('createOTABtn');
        
        // Set up click handler for rate assignment buttons
        if (assignRatesBtn) {
            assignRatesBtn.addEventListener('click', handleRateSubmission);
        }
        if (createOTABtn) {
            createOTABtn.addEventListener('click', handleRateSubmission);
        }
        
        function handleRateSubmission(e) {
            e.preventDefault();
            
            // Get form data
            const form = document.getElementById('rateAssignmentForm');
            if (!form) return;
            
            // Get provider network status
            const providerNetwork = document.getElementById('provider-network').value;
            const isInNetwork = providerNetwork === 'In Network';
            
            // Get active tab
            const activeTab = document.querySelector('.tab-pane.active');
            const isIndividualRates = activeTab.id === 'individual-rates';
            
            // Prepare request data
            let requestData = {
                rate_type: isInNetwork ? (isIndividualRates ? 'individual' : 'category') : 'create_ota'
            };
            
            // Collect data based on active tab
            if (isIndividualRates || !isInNetwork) {
                const rates = [];
                document.querySelectorAll('[data-cpt-code]').forEach(el => {
                    const cptCode = el.dataset.cptCode;
                    const rateInput = document.getElementById(`rate-input-${cptCode}`);
                    const modifierInput = el.querySelector(`[name="modifier-${cptCode}"]`);
                    const modifier = modifierInput ? modifierInput.value : '';
                    
                    if (rateInput && rateInput.value) {
                        rates.push({
                            cpt_code: cptCode,
                            rate: parseFloat(rateInput.value),
                            modifier: modifier || null
                        });
                    }
                });
                requestData.rates = rates;
            } else {
                const categoryRates = {};
                document.querySelectorAll('[name^="category_enabled["]').forEach(checkbox => {
                    if (checkbox.checked) {
                        const categoryName = checkbox.name.match(/\[(.*?)\]/)[1];
                        const rateInput = document.querySelector(`[name="category_rate[${categoryName}]"]`);
                        
                        if (rateInput && rateInput.value) {
                            categoryRates[categoryName] = parseFloat(rateInput.value);
                        }
                    }
                });
                requestData.category_rates = categoryRates;
            }
            
            // Add notes if provided
            const notesTextarea = document.getElementById('rate-notes');
            if (notesTextarea && notesTextarea.value.trim()) {
                requestData.notes = notesTextarea.value.trim();
            }
            
            console.log("Sending rate data:", requestData);
            
            // Show loading state
            const button = this;
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Processing...';
            
            // Get the filename
            const filename = document.getElementById('filename').value;
            
            // Send AJAX request
            const url = `/processing/fails/${filename}/assign-rates`;
            console.log("Sending request to:", url);
            
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                console.log("Received response status:", response.status);
                return response.json();
            })
            .then(data => {
                console.log("Response data:", data);
                if (data.status === 'success') {
                    // Show success message
                    alert(data.message);
                    
                    // Hide modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('rateAssignmentModal'));
                    if (modal) modal.hide();
                    
                    // CRITICAL FIX: Force redirect to the list view
                    console.log("Redirecting to /processing/fails");
                    window.location.href = '/processing/fails';
                } else {
                    alert(data.message || 'Error assigning rates');
                    button.disabled = false;
                    button.innerHTML = originalText;
                }
            })
            .catch(error => {
                console.error("Error submitting rate data:", error);
                alert('Error: ' + error.message);
                button.disabled = false;
                button.innerHTML = originalText;
            });
        }

        // Handle category rate checkbox changes
        document.querySelectorAll('[name^="category_enabled["]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const rateInput = this.closest('.col-md-4, .col-md-6').querySelector('[name^="category_rate["]');
                if (this.checked) {
                    rateInput.required = true;
                    rateInput.disabled = false;
                } else {
                    rateInput.required = false;
                    rateInput.disabled = true;
                    rateInput.value = '';
                }
            });

            // Initialize state
            const rateInput = checkbox.closest('.col-md-4, .col-md-6').querySelector('[name^="category_rate["]');
            rateInput.disabled = !checkbox.checked;
            rateInput.required = checkbox.checked;
        });

        // Handle tab switching
        document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(tab => {
            tab.addEventListener('shown.bs.tab', function(event) {
                const activeTab = event.target.getAttribute('id');
                const individualRatesInputs = document.querySelectorAll('#individual-rates input[name="rate"]');
                const categoryRatesCheckboxes = document.querySelectorAll('[name^="category_enabled["]');
                
                // Get provider network status
                const providerNetwork = document.getElementById('provider-network').value;
                const isInNetwork = providerNetwork === 'In Network';
                
                // Toggle required fields based on active tab
                if (activeTab === 'individual-rates-tab') {
                    individualRatesInputs.forEach(input => input.required = true);
                    categoryRatesCheckboxes.forEach(checkbox => {
                        const rateInput = checkbox.closest('.col-md-4, .col-md-6').querySelector('[name^="category_rate["]');
                        rateInput.required = false;
                    });
                } else {
                    // Only apply category rates if it's in-network
                    if (isInNetwork) {
                        individualRatesInputs.forEach(input => input.required = false);
                        categoryRatesCheckboxes.forEach(checkbox => {
                            const rateInput = checkbox.closest('.col-md-4, .col-md-6').querySelector('[name^="category_rate["]');
                            rateInput.required = checkbox.checked;
                        });
                    } else {
                        // Force back to individual rates for OTA
                        const individualTab = document.getElementById('individual-rates-tab');
                        if (individualTab) {
                            individualTab.click();
                        }
                    }
                }
            });
        });

        // Handle PDF view button
        viewPdfButton.addEventListener('click', async function() {
            try {
                const response = await fetch(`/processing/fails/{{ filename }}/pdf`);
                const data = await response.json();
                
                if (data.url) {
                    window.open(data.url, '_blank');
                } else {
                    showAlert('error', 'PDF not found or error occurred');
                }
            } catch (error) {
                showAlert('error', 'Error fetching PDF: ' + error.message);
            }
        });

        // Function to show alerts
        function showAlert(type, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            // Insert alert at the top of the page
            const container = document.querySelector('.container-fluid');
            container.insertBefore(alertDiv, container.firstChild);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Function to confirm moving a file back to staging
        function confirmMoveToStaging() {
            if (confirm('Are you sure you want to move this file back to staging?\n\nThis will clear all validation failures and submit the file for reprocessing.')) {
                document.getElementById('form-action').value = 'back_to_staging';
                document.querySelector('form[action*="submit_fail_file"]').submit();
            }
        }

        // Handle form validation for escalation form
        if (escalateForm) {
            // Real-time validation on reason field
            reasonTextarea.addEventListener('input', function() {
                if (this.value.trim()) {
                    this.classList.remove('is-invalid');
                }
            });
            
            // Form validation before submission
            escalateForm.addEventListener('submit', function(event) {
                // Prevent default form submission
                event.preventDefault();
                
                // Validate reason field
                const reason = reasonTextarea.value.trim();
                if (!reason) {
                    reasonTextarea.classList.add('is-invalid');
                    showAlert('error', 'Please provide a reason for escalation');
                    return false;
                }
                
                // Remove any previous validation styling
                reasonTextarea.classList.remove('is-invalid');
                
                // Show loading state
                const submitButton = escalateForm.querySelector('button[type="submit"]');
                const originalButtonText = submitButton.innerHTML;
                submitButton.disabled = true;
                submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
                
                // Submit form using fetch API for better control
                fetch(escalateForm.action, {
                    method: 'POST',
                    body: new FormData(escalateForm),
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Show success message
                        showAlert('success', data.message);
                        
                        // Hide modal
                        escalateModalInstance.hide();
                        
                        // Redirect after a short delay
                        setTimeout(() => {
                            window.location.href = data.redirect;
                        }, 1500);
                    } else {
                        // Show error message
                        showAlert('error', data.message || 'An error occurred during escalation');
                        
                        // Reset button
                        submitButton.disabled = false;
                        submitButton.innerHTML = originalButtonText;
                    }
                })
                .catch(error => {
                    // Show error message
                    showAlert('error', 'Error during escalation: ' + error.message);
                    
                    // Reset button
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalButtonText;
                });
            });
            
            // Reset form when modal is hidden
            escalateModal.addEventListener('hidden.bs.modal', function() {
                escalateForm.reset();
                reasonTextarea.classList.remove('is-invalid');
                
                // Reset any loading states
                const submitButton = escalateForm.querySelector('button[type="submit"]');
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>Escalate File';
            });
        }

        // Handle form validation for denial form
        if (denyForm) {
            // Form validation before submission
            denyForm.addEventListener('submit', function(event) {
                // Prevent default form submission
                event.preventDefault();
                
                // Get form elements
                const reasonInputs = denyForm.querySelectorAll('input[name="reason"]');
                let reasonSelected = false;
                
                // Check if any reason is selected
                reasonInputs.forEach(input => {
                    if (input.checked) {
                        reasonSelected = true;
                    }
                });
                
                // Prevent submission if no reason selected
                if (!reasonSelected) {
                    showAlert('error', 'Please select a reason for denial');
                    return false;
                }
                
                // Show loading state
                const submitButton = denyForm.querySelector('button[type="submit"]');
                const originalButtonText = submitButton.innerHTML;
                submitButton.disabled = true;
                submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
                
                // Submit form using fetch API for better control
                fetch(denyForm.action, {
                    method: 'POST',
                    body: new FormData(denyForm),
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Show success message
                        showAlert('success', data.message);
                        
                        // Hide modal
                        denyModalInstance.hide();
                        
                        // Redirect after a short delay
                        setTimeout(() => {
                            window.location.href = data.redirect;
                        }, 1500);
                    } else {
                        // Show error message
                        showAlert('error', data.message || 'An error occurred during denial');
                        
                        // Reset button
                        submitButton.disabled = false;
                        submitButton.innerHTML = originalButtonText;
                    }
                })
                .catch(error => {
                    // Show error message
                    showAlert('error', 'Error during denial: ' + error.message);
                    
                    // Reset button
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalButtonText;
                });
            });
            
            // Reset form when modal is hidden
            denyModal.addEventListener('hidden.bs.modal', function() {
                denyForm.reset();
                
                // Reset any loading states
                const submitButton = denyForm.querySelector('button[type="submit"]');
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fas fa-ban me-1"></i>Deny Bill';
            });
        }

        // Handle form submission for ready for process form
        if (readyForProcessForm) {
            readyForProcessForm.addEventListener('submit', function(event) {
                // Prevent default form submission
                event.preventDefault();
                
                // Show loading state
                const submitButton = readyForProcessForm.querySelector('button[type="submit"]');
                const originalButtonText = submitButton.innerHTML;
                submitButton.disabled = true;
                submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
                
                // Submit form using fetch API
                fetch(readyForProcessForm.action, {
                    method: 'POST',
                    body: new FormData(readyForProcessForm),
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Show success message
                        showAlert('success', data.message);
                        
                        // Hide modal
                        readyForProcessModalInstance.hide();
                        
                        // Redirect after a short delay
                        setTimeout(() => {
                            window.location.href = data.redirect;
                        }, 1500);
                    } else {
                        // Show error message
                        showAlert('error', data.message || 'An error occurred during the process');
                        
                        // Reset button
                        submitButton.disabled = false;
                        submitButton.innerHTML = originalButtonText;
                    }
                })
                .catch(error => {
                    // Show error message
                    showAlert('error', 'Error: ' + error.message);
                    
                    // Reset button
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalButtonText;
                });
            });
        }

        // Initialize popovers
        var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
        var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
            return new bootstrap.Popover(popoverTriggerEl)
        });
    });
</script>

<!-- Escalation Modal -->
<div class="modal fade" id="escalateModal" tabindex="-1" aria-labelledby="escalateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="escalateModalLabel">Escalate File</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="escalate-form" method="POST" action="{{ url_for('processing.escalate_fail_file', filename=filename) }}">
                <div class="modal-body">
                    <!-- Add hidden field for filter parameters -->
                    {% if filter_params %}
                    <input type="hidden" name="filter_params" value="{{ filter_params|tojson }}">
                    {% endif %}
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-1"></i>
                        <strong>What happens during escalation:</strong>
                        <ul class="mb-0 mt-1">
                            <li>The file will be moved to the escalations folder</li>
                            <li>It will be removed from the failed bills dashboard</li>
                            <li>An escalation specialist will review the file</li>
                        </ul>
                    </div>
                    
                    <div class="mb-3">
                        <label for="escalate-reason" class="form-label">Reason for Escalation</label>
                        <textarea class="form-control" id="escalate-reason" name="reason" rows="3" required
                                  placeholder="Provide a detailed reason for escalating this file..."></textarea>
                        <div class="form-text">Please include specific details about why this file needs escalation. This information will help the specialist address the issue effectively.</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">File Details</label>
                        <ul class="list-group">
                            <li class="list-group-item"><strong>Filename:</strong> {{ filename }}</li>
                            <li class="list-group-item"><strong>Provider:</strong> {{ json_data.filemaker.provider['Billing Name']|default(json_data.billing_info.billing_provider_name, true)|default('Unknown Provider', true) }}</li>
                            <li class="list-group-item"><strong>Total Charge:</strong> {{ json_data.billing_info.total_charge|default('N/A', true) }}</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-exclamation-triangle me-1"></i>Escalate File
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Denial Modal -->
<div class="modal fade" id="denyModal" tabindex="-1" aria-labelledby="denyModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="denyModalLabel">Deny Bill</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="deny-form" method="POST" action="{{ url_for('processing.deny_fail_file', filename=filename) }}">
                <div class="modal-body">
                    <!-- Add hidden field for filter parameters -->
                    {% if filter_params %}
                    <input type="hidden" name="filter_params" value="{{ filter_params|tojson }}">
                    {% endif %}
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        <strong>Warning: Denying a bill is permanent</strong>
                        <p class="mb-0 mt-1">This action will move the bill to the denials folder and remove it from the processing queue. This action cannot be easily reversed.</p>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Bill Information</label>
                        <ul class="list-group mb-3">
                            <li class="list-group-item"><strong>Filename:</strong> {{ filename }}</li>
                            <li class="list-group-item"><strong>Provider:</strong> {{ json_data.filemaker.provider['Billing Name']|default(json_data.billing_info.billing_provider_name, true)|default('Unknown Provider', true) }}</li>
                            <li class="list-group-item"><strong>Total Charge:</strong> {{ json_data.billing_info.total_charge|default('N/A', true) }}</li>
                            <li class="list-group-item">
                                <strong>CPT Codes:</strong> 
                                {% for line in json_data.service_lines %}
                                    {{ line.cpt_code }}{% if not loop.last %}, {% endif %}
                                {% else %}
                                    None available
                                {% endfor %}
                            </li>
                        </ul>
                        
                        <label class="form-label">Reason for Denial</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="reason" id="reason-co50" value="CO-50" required>
                            <label class="form-check-label" for="reason-co50">CO-50 - These are non-covered services</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="reason" id="reason-nofm" value="Claim not found in FileMaker" required>
                            <label class="form-check-label" for="reason-nofm">Claim not found in FileMaker</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-ban me-1"></i>Deny Bill
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}