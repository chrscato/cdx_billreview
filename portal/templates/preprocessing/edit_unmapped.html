{% extends "base.html" %}

{% block title %}Edit Unmapped File - Bill Review Portal{% endblock %}

{% block content %}
<style>
    /* Ensure escalate button is clickable */
    .btn-danger[data-bs-target="#escalationModal"] {
        position: relative;
        z-index: 1;
        cursor: pointer;
    }
    
    /* Ensure button is not covered by other elements */
    .d-flex.gap-2 {
        position: relative;
        z-index: 1;
    }
</style>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex align-items-center">
            <h1 class="mb-0">{{ filename }}</h1>
            <div class="ms-3">
                <span class="badge bg-secondary">{{ current_index }} of {{ total_files }}</span>
                {% if unmapped_count > 0 %}
                <span class="badge bg-warning ms-2">{{ unmapped_count }} total</span>
                {% endif %}
            </div>
        </div>
        <div class="d-flex gap-2">
            {% if prev_file %}
            <a href="{{ url_for('preprocessing.view_unmapped_file', filename=prev_file) }}" 
               class="btn btn-outline-secondary">
                <i class="fas fa-chevron-left me-1"></i>Previous
            </a>
            {% endif %}
            <a href="{{ url_for('preprocessing.list_unmapped_files') }}" class="btn btn-outline-secondary">
                Back to List
            </a>
            {% if next_file %}
            <a href="{{ url_for('preprocessing.view_unmapped_file', filename=next_file) }}" 
               class="btn btn-outline-secondary">
                Next<i class="fas fa-chevron-right ms-1"></i>
            </a>
            {% endif %}
            <button id="view-pdf" class="btn btn-outline-primary">
                <i class="fas fa-file-pdf me-1"></i>View PDF
            </button>
            <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#escalationModal">
                <i class="fas fa-exclamation-triangle me-1"></i>Escalate
            </button>
        </div>
    </div>

    <form method="POST" action="{{ url_for('preprocessing.submit_unmapped_file', filename=filename) }}">
        <!-- Patient Info Section -->
        <div class="mb-4">
            <div class="card mb-3">
                <div class="card-header">
                    <h3 class="card-title mb-0">Patient Information</h3>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Patient Name</label>
                            <input type="text" class="form-control" name="patient_info[patient_name]" 
                                   value="{{ json_data.patient_info.patient_name }}">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Date of Birth</label>
                            <input type="text" class="form-control" name="patient_info[patient_dob]" 
                                   value="{{ json_data.patient_info.patient_dob }}" placeholder="MM/DD/YYYY">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">ZIP Code</label>
                            <input type="text" class="form-control" name="patient_info[patient_zip]" 
                                   value="{{ json_data.patient_info.patient_zip }}">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Billing Info Section -->
        <div class="mb-4">
            <div class="card mb-3">
                <div class="card-header">
                    <h3 class="card-title mb-0">Billing Information</h3>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Provider Name</label>
                            <input type="text" class="form-control" name="billing_info[billing_provider_name]" 
                                   value="{{ json_data.billing_info.billing_provider_name }}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Provider NPI</label>
                            <input type="text" class="form-control" name="billing_info[billing_provider_npi]" 
                                   value="{{ json_data.billing_info.billing_provider_npi }}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Provider Address</label>
                            <input type="text" class="form-control" name="billing_info[billing_provider_address]" 
                                   value="{{ json_data.billing_info.billing_provider_address }}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Provider TIN</label>
                            <input type="text" class="form-control" name="billing_info[billing_provider_tin]" 
                                   value="{{ json_data.billing_info.billing_provider_tin }}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Patient Account No</label>
                            <input type="text" class="form-control" name="billing_info[patient_account_no]" 
                                   value="{{ json_data.billing_info.patient_account_no }}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Total Charge</label>
                            <input type="text" class="form-control" name="billing_info[total_charge]" 
                                   value="{{ json_data.billing_info.total_charge }}" placeholder="$0.00">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Service Lines Section -->
        <div class="mb-4">
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="card-title mb-0">Service Lines</h3>
                    <button type="button" class="btn btn-primary" id="add-line">Add Service Line</button>
                </div>
                <div class="card-body">
                    <div id="service-lines">
                        {% for line in json_data.service_lines %}
                        <div class="service-line border rounded p-3 mb-3" data-index="{{ loop.index0 }}">
                            <div class="row g-3">
                                <div class="col-md-2">
                                    <label class="form-label">CPT Code</label>
                                    <input type="text" class="form-control" 
                                           name="service_lines[{{ loop.index0 }}][cpt_code]" 
                                           value="{{ line.cpt_code }}">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Charge Amount</label>
                                    <input type="text" class="form-control" 
                                           name="service_lines[{{ loop.index0 }}][charge_amount]" 
                                           value="{{ line.charge_amount }}" placeholder="$0.00">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Date of Service</label>
                                    <input type="text" class="form-control" 
                                           name="service_lines[{{ loop.index0 }}][date_of_service]" 
                                           value="{{ line.date_of_service }}" placeholder="MM/DD/YY - MM/DD/YY">
                                </div>
                                <div class="col-md-1">
                                    <label class="form-label">Units</label>
                                    <input type="text" class="form-control" 
                                           name="service_lines[{{ loop.index0 }}][units]" 
                                           value="{{ line.units }}">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Place of Service</label>
                                    <input type="text" class="form-control" 
                                           name="service_lines[{{ loop.index0 }}][place_of_service]" 
                                           value="{{ line.place_of_service }}">
                                </div>
                                <div class="col-md-1">
                                    <label class="form-label">Diagnosis</label>
                                    <input type="text" class="form-control" 
                                           name="service_lines[{{ loop.index0 }}][diagnosis_pointer]" 
                                           value="{{ line.diagnosis_pointer }}">
                                </div>
                                <div class="col-md-1">
                                    <label class="form-label">Modifiers</label>
                                    <input type="text" class="form-control" 
                                           name="service_lines[{{ loop.index0 }}][modifiers]" 
                                           value="{{ line.modifiers|join(',') if line.modifiers else '' }}" 
                                           placeholder="RT,LT">
                                </div>
                                <div class="col-md-1">
                                    <label class="form-label">&nbsp;</label>
                                    <button type="button" class="btn btn-danger d-block w-100 remove-line">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- FileMaker Match Lookup Section -->
        <div class="mb-4">
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="card-title mb-0">FileMaker Match Lookup</h3>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="autosearchToggle" checked>
                        <label class="form-check-label" for="autosearchToggle">Auto-Search</label>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row g-3 mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="last-name-search" aria-label="Last name for search">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">First Name</label>
                            <input type="text" class="form-control" id="first-name-search" aria-label="First name for search">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Date of Service</label>
                            <input type="text" class="form-control" id="dos-search" placeholder="YYYY-MM-DD" aria-label="Date of service for search">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-12 d-flex justify-content-between align-items-center flex-wrap gap-2">
                            <div class="btn-group">
                                <button type="button" class="btn btn-primary" id="search-button" aria-label="Search for matches">
                                    <i class="bi bi-search me-1"></i>Search
                                </button>
                                <button type="button" class="btn btn-secondary" id="clear-search-button" aria-label="Clear search form">
                                    <i class="bi bi-x-circle me-1"></i>Clear
                                </button>
                            </div>
                            <button type="button" class="btn btn-info" id="show-all-matches-button" 
                                    data-bs-toggle="tooltip" data-bs-placement="top" 
                                    title="Search with just the last name to show more potential matches"
                                    aria-label="Show all possible matches">
                                <i class="bi bi-list-ul me-1"></i>Show All Matches
                            </button>
                        </div>
                    </div>
                    
                    <div id="search-results" class="mt-3" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Matching Orders</h5>
                            <span id="match-counter" class="badge bg-primary">0 matches found</span>
                        </div>
                        <div class="list-group" id="matches-list">
                            <!-- Results will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <input type="hidden" name="action" id="form-action" value="save">
            <button type="submit" class="btn btn-primary me-2" onclick="document.getElementById('form-action').value='save'">
                Save Changes
            </button>
            <button type="submit" class="btn btn-success" onclick="document.getElementById('form-action').value='approve'">
                Approve & Move to Valid
            </button>
        </div>
    </form>
</div>

<!-- Template for new service line -->
<template id="service-line-template">
    <div class="service-line border rounded p-3 mb-3" data-index="INDEX">
        <div class="row g-3">
            <div class="col-md-2">
                <label class="form-label">CPT Code</label>
                <input type="text" class="form-control" 
                       name="service_lines[INDEX][cpt_code]" 
                       placeholder="Enter CPT Code">
            </div>
            <div class="col-md-2">
                <label class="form-label">Charge Amount</label>
                <input type="text" class="form-control" 
                       name="service_lines[INDEX][charge_amount]" 
                       placeholder="$0.00">
            </div>
            <div class="col-md-2">
                <label class="form-label">Date of Service</label>
                <input type="text" class="form-control" 
                       name="service_lines[INDEX][date_of_service]" 
                       placeholder="MM/DD/YY - MM/DD/YY">
            </div>
            <div class="col-md-1">
                <label class="form-label">Units</label>
                <input type="text" class="form-control" 
                       name="service_lines[INDEX][units]" 
                       placeholder="0">
            </div>
            <div class="col-md-2">
                <label class="form-label">Place of Service</label>
                <input type="text" class="form-control" 
                       name="service_lines[INDEX][place_of_service]" 
                       placeholder="07">
            </div>
            <div class="col-md-1">
                <label class="form-label">Diagnosis</label>
                <input type="text" class="form-control" 
                       name="service_lines[INDEX][diagnosis_pointer]" 
                       placeholder="1">
            </div>
            <div class="col-md-1">
                <label class="form-label">Modifiers</label>
                <input type="text" class="form-control" 
                       name="service_lines[INDEX][modifiers]" 
                       placeholder="RT,LT">
            </div>
            <div class="col-md-1">
                <label class="form-label">&nbsp;</label>
                <button type="button" class="btn btn-danger d-block w-100 remove-line">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
    </div>
</template>

<!-- Loading spinner template -->
<template id="loading-spinner-template">
    <div class="text-center my-4">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Searching for matches...</p>
    </div>
</template>

<!-- Escalation Modal -->
<div class="modal fade" id="escalationModal" tabindex="-1" role="dialog" aria-labelledby="escalationModalLabel">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h4 class="modal-title" id="escalationModalLabel">Escalate Unmapped File</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="escalationForm">
                    <div class="form-group">
                        <label for="escalationReason" class="control-label">Reason for Escalation<span class="text-danger">*</span></label>
                        <select class="form-control" id="escalationReason" name="reason" required>
                            <option value="" selected disabled>Select a reason...</option>
                            <option value="not_found">Not found in FileMaker</option>
                            <option value="incorrect_patient">Incorrect patient information</option>
                            <option value="missing_data">Missing critical data</option>
                            <option value="duplicate">Potential duplicate</option>
                            <option value="illegible">Document illegible</option>
                            <option value="other">Other reason</option>
                        </select>
                        <div class="help-block">
                            Please select a reason for escalation.
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="escalationNotes" class="control-label">Additional Notes</label>
                        <textarea class="form-control" id="escalationNotes" name="notes" rows="4" placeholder="Please provide any additional details that would help resolve this issue..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmEscalation">Confirm Escalation</button>
            </div>
        </div>
    </div>
</div>

<script>
// Utility function for debouncing
function debounce(func, wait) {
    let timeout;
    return function(...args) {
        const context = this;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), wait);
    };
}

/**
 * Navigate to the next file or fall back to the list if at the end
 * @param {string} message - Optional message to show before navigation
 * @param {string} type - Type of message: "success", "error", "info", "warning"
 * @param {number} delay - Delay in ms before navigation
 */
function navigateToNextFile(message = null, type = "success", delay = 1500) {
    // Get next file info
    const nextFile = '{{ next_file }}';
    
    // Show loading overlay
    const overlay = document.createElement('div');
    overlay.className = 'position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center';
    overlay.style.backgroundColor = 'rgba(0,0,0,0.3)';
    overlay.style.zIndex = '9999';
    overlay.id = 'navigation-overlay';
    
    // Create the content
    let spinnerHTML = `
        <div class="bg-white p-4 rounded shadow-lg text-center">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
    `;
    
    // Add message if provided
    if (message) {
        spinnerHTML += `<p class="mb-0">${message}</p>`;
    } else {
        spinnerHTML += nextFile 
            ? `<p class="mb-0">Loading next file...</p>` 
            : `<p class="mb-0">Returning to file list...</p>`;
    }
    
    spinnerHTML += `</div>`;
    overlay.innerHTML = spinnerHTML;
    
    // Add to DOM
    document.body.appendChild(overlay);
    
    // Show message toast if provided
    if (message && typeof showToast === 'function') {
        showToast(message, type);
    }
    
    // Navigate after delay
    setTimeout(() => {
        if (nextFile) {
            console.log('[DEBUG] Navigating to next file:', nextFile);
            window.location.href = `/preprocessing/unmapped/${nextFile}`;
        } else {
            console.log('[DEBUG] No more files, returning to unmapped list');
            window.location.href = "/preprocessing/unmapped";
        }
    }, delay);
}

// Function to highlight text in search results
function highlightText(text, searchTerm) {
    if (!searchTerm || !text) return text;
    const regex = new RegExp(`(${searchTerm})`, 'gi');
    return text.replace(regex, '<mark>$1</mark>');
}

// Function to calculate string similarity (Levenshtein distance)
function calculateSimilarity(s1, s2) {
    if (!s1 || !s2) return 0;
    s1 = s1.toLowerCase();
    s2 = s2.toLowerCase();
    
    const costs = [];
    for (let i = 0; i <= s1.length; i++) {
        let lastValue = i;
        for (let j = 0; j <= s2.length; j++) {
            if (i === 0) {
                costs[j] = j;
            } else if (j > 0) {
                let newValue = costs[j - 1];
                if (s1.charAt(i - 1) !== s2.charAt(j - 1)) {
                    newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                }
                costs[j - 1] = lastValue;
                lastValue = newValue;
            }
        }
        if (i > 0) costs[s2.length] = lastValue;
    }
    
    // Convert to a similarity percentage (higher is better)
    const maxLength = Math.max(s1.length, s2.length);
    if (maxLength === 0) return 100;
    return Math.round((1 - costs[s2.length] / maxLength) * 100);
}

// Search cache
const searchCache = new Map();

document.addEventListener('DOMContentLoaded', function() {
    // Debug Bootstrap initialization
    console.log('Bootstrap available:', typeof bootstrap !== 'undefined');
    if (typeof bootstrap !== 'undefined') {
        console.log('Modal available:', typeof bootstrap.Modal !== 'undefined');
    }

    // Initialize tooltips
    if (typeof $ !== 'undefined') {
        $('[data-toggle="tooltip"]').tooltip();
    }

    // Add click handler to escalate button
    const escalateButton = document.querySelector('button[data-target="#escalationModal"]');
    if (escalateButton) {
        console.log('Escalate button found');
        escalateButton.addEventListener('click', function(e) {
            console.log('Escalate button clicked');
            e.preventDefault();
            $('#escalationModal').modal('show');
        });
    } else {
        console.log('Escalate button not found');
    }
    
    // Escalation form handling
    const escalationForm = document.getElementById('escalationForm');
    const confirmEscalationBtn = document.getElementById('confirmEscalation');
    
    if (escalationForm && confirmEscalationBtn) {
        confirmEscalationBtn.addEventListener('click', async function() {
            // Add was-validated class to show validation feedback
            escalationForm.classList.add('was-validated');
            
            // Check if form is valid
            if (escalationForm.checkValidity()) {
                // Get form data
                const reason = document.getElementById('escalationReason').value;
                const notes = document.getElementById('escalationNotes').value.trim();
                
                // Send the data to the server
                try {
                    const response = await fetch(`/preprocessing/unmapped/{{ filename }}/escalate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            reason: reason,
                            notes: notes
                        })
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        // Show success message
                        $('#escalationModal').modal('hide');
                        
                        // Show success alert
                        const alertHtml = `
                            <div class="alert alert-success alert-dismissible fade in" role="alert">
                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                                <strong>Success!</strong> This file has been escalated for review.
                            </div>
                        `;
                        document.querySelector('.container-fluid').insertAdjacentHTML('afterbegin', alertHtml);
                        
                        // Reset form
                        escalationForm.classList.remove('was-validated');
                        escalationForm.reset();
                    } else {
                        // Show error message
                        const alertHtml = `
                            <div class="alert alert-danger alert-dismissible fade in" role="alert">
                                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                                <strong>Error!</strong> Failed to escalate file: ${data.error || 'Unknown error'}
                            </div>
                        `;
                        document.querySelector('.container-fluid').insertAdjacentHTML('afterbegin', alertHtml);
                    }
                } catch (error) {
                    // Show error message
                    const alertHtml = `
                        <div class="alert alert-danger alert-dismissible fade in" role="alert">
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                            <strong>Error!</strong> Failed to escalate file: ${error.message}
                        </div>
                    `;
                    document.querySelector('.container-fluid').insertAdjacentHTML('afterbegin', alertHtml);
                }
            }
        });
    }
    
    // Prepopulate search fields functionality
    prepopulateSearchFields();
    
    // Load autosearch toggle state from localStorage
    const autosearchToggle = document.getElementById('autosearchToggle');
    if (autosearchToggle) {
        const savedState = localStorage.getItem('autosearchEnabled');
        if (savedState !== null) {
            autosearchToggle.checked = savedState === 'true';
        }
        
        // Save toggle state to localStorage when changed
        autosearchToggle.addEventListener('change', function() {
            localStorage.setItem('autosearchEnabled', this.checked);
        });
    }
    
    // Add service line functionality
    const addLineButton = document.getElementById('add-line');
    const serviceLinesContainer = document.getElementById('service-lines');
    const template = document.getElementById('service-line-template');

    addLineButton.addEventListener('click', function() {
        const newLine = template.content.cloneNode(true);
        const index = serviceLinesContainer.children.length;
        newLine.querySelector('.service-line').dataset.index = index;
        
        // Update all input names with the new index
        newLine.querySelectorAll('input').forEach(input => {
            input.name = input.name.replace('INDEX', index);
        });
        
        serviceLinesContainer.appendChild(newLine);
    });

    // Remove service line functionality
    serviceLinesContainer.addEventListener('click', function(e) {
        if (e.target.closest('.remove-line')) {
            e.target.closest('.service-line').remove();
            // Update indices of remaining lines
            document.querySelectorAll('.service-line').forEach((line, index) => {
                line.dataset.index = index;
                line.querySelectorAll('input').forEach(input => {
                    input.name = input.name.replace(/\[\d+\]/, `[${index}]`);
                });
            });
        }
    });

    // PDF viewer functionality
    const viewPdfButton = document.getElementById('view-pdf');
    viewPdfButton.addEventListener('click', async function() {
        try {
            const response = await fetch(`/preprocessing/unmapped/{{ filename }}/pdf`);
            const data = await response.json();
            
            if (data.url) {
                window.open(data.url, '_blank');
            } else {
                alert('PDF not found or error occurred');
            }
        } catch (error) {
            alert('Error fetching PDF: ' + error.message);
        }
    });

    // FileMaker search functionality
    const searchButton = document.getElementById('search-button');
    const clearSearchButton = document.getElementById('clear-search-button');
    const showAllMatchesButton = document.getElementById('show-all-matches-button');
    const searchResults = document.getElementById('search-results');
    const matchesList = document.getElementById('matches-list');
    const matchCounter = document.getElementById('match-counter');
    
    // Store original search button text
    const originalButtonText = searchButton.innerHTML;
    
    // Search fields
    const lastNameField = document.getElementById('last-name-search');
    const firstNameField = document.getElementById('first-name-search');
    const dosSearchField = document.getElementById('dos-search');
    
    // Add event listeners to search fields for keyboard shortcuts
    [lastNameField, firstNameField, dosSearchField].forEach(field => {
        field.addEventListener('keydown', function(e) {
            // Enter key to trigger search
            if (e.key === 'Enter') {
                e.preventDefault();
                searchButton.click();
            }
            // Escape key to clear form
            else if (e.key === 'Escape') {
                e.preventDefault();
                clearSearchButton.click();
            }
        });
        
        // Add debounced input handler for auto-search
        field.addEventListener('input', debounce(function() {
            if (document.getElementById('autosearchToggle').checked) {
                // Only auto-search if the last name has at least 3 characters
                const lastNameValue = lastNameField.value.trim();
                
                if (lastNameValue.length >= 3) {
                    searchButton.click();
                }
            }
        }, 300));
    });
    
    // Clear search button functionality
    clearSearchButton.addEventListener('click', function() {
        lastNameField.value = '';
        firstNameField.value = '';
        dosSearchField.value = '';
        searchResults.style.display = 'none';
    });
    
    // Show all matches button functionality
    showAllMatchesButton.addEventListener('click', function() {
        // Keep last name, clear other fields
        firstNameField.value = '';
        dosSearchField.value = '';
        // Only trigger search if last name has value
        if (lastNameField.value.trim()) {
            searchButton.click();
        } else {
            // If no last name, prompt the user
            matchesList.innerHTML = '<div class="alert alert-warning">Please enter a last name to show all matches</div>';
            searchResults.style.display = 'block';
        }
    });

    searchButton.addEventListener('click', async function() {
        const lastName = lastNameField.value.trim();
        const firstName = firstNameField.value.trim();
        const dos = dosSearchField.value.trim();
        
        // Generate cache key
        const cacheKey = `${lastName}_${firstName}_${dos}`;
        
        // Show loading state
        searchButton.disabled = true;
        searchButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Searching...';
        
        // Show search results area with loading spinner
        searchResults.style.display = 'block';
        const loadingSpinner = document.getElementById('loading-spinner-template').content.cloneNode(true);
        matchesList.innerHTML = '';
        matchesList.appendChild(loadingSpinner);
        matchCounter.textContent = 'Searching...';

        try {
            // Check cache first
            let data;
            if (searchCache.has(cacheKey)) {
                console.log('Using cached search results');
                data = searchCache.get(cacheKey);
            } else {
                const response = await fetch(`/preprocessing/unmapped/{{ filename }}/search`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        last_name: lastName,
                        first_name: firstName,
                        dos: dos
                    })
                });

                data = await response.json();
                
                // Cache the result
                if (data.success) {
                    searchCache.set(cacheKey, data);
                }
            }
            
            // Clear loading spinner
            matchesList.innerHTML = '';
            
            if (data.success) {
                const matches = data.matches || [];
                
                // Update match counter
                matchCounter.textContent = `${matches.length} ${matches.length === 1 ? 'match' : 'matches'} found`;
                
                if (matches.length === 0) {
                    matchesList.innerHTML = '<div class="alert alert-info">No matches found</div>';
                } else {
                    // Calculate similarity scores and sort by relevance
                    const enhancedMatches = matches.map(match => {
                        // Extract patient name parts for comparison
                        const patientName = match.patient_name || '';
                        const nameParts = patientName.split(/,\s*|\s+/);
                        const matchLastName = nameParts.length > 0 ? nameParts[0] : '';
                        const matchFirstName = nameParts.length > 1 ? nameParts[1] : '';
                        
                        // Calculate similarity scores
                        const lastNameSimilarity = calculateSimilarity(lastName, matchLastName);
                        const firstNameSimilarity = firstName ? calculateSimilarity(firstName, matchFirstName) : 0;
                        
                        // Calculate overall relevance score (weighted average)
                        const relevanceScore = lastName && firstName 
                            ? (lastNameSimilarity * 0.6) + (firstNameSimilarity * 0.4)
                            : lastNameSimilarity;
                            
                        return {
                            ...match,
                            relevanceScore,
                            lastNameSimilarity,
                            firstNameSimilarity
                        };
                    });
                    
                    // Sort by relevance score (highest first)
                    enhancedMatches.sort((a, b) => b.relevanceScore - a.relevanceScore);
                    
                    enhancedMatches.forEach(match => {
                        const card = document.createElement('div');
                        card.className = 'card mb-3';
                        
                        // Determine match quality badge
                        let matchQuality = '';
                        if (match.relevanceScore >= 90) {
                            matchQuality = '<span class="badge bg-success ms-2">Strong Match</span>';
                        } else if (match.relevanceScore >= 70) {
                            matchQuality = '<span class="badge bg-info ms-2">Good Match</span>';
                        } else if (match.relevanceScore >= 50) {
                            matchQuality = '<span class="badge bg-warning ms-2">Potential Match</span>';
                        } else {
                            matchQuality = '<span class="badge bg-secondary ms-2">Weak Match</span>';
                        }
                        
                        // Highlight matching text
                        const highlightedName = highlightText(match.patient_name || '', lastName) || 
                                             highlightText(match.patient_name || '', firstName);
                        
                        card.innerHTML = `
                            <div class="card-body">
                                <h5 class="card-title mb-2 d-flex align-items-center">
                                    <span>Order ID: ${match.order_id}</span>
                                    ${matchQuality}
                                </h5>
                                <p><strong>Patient:</strong> ${highlightedName} (DOB: ${match.patient_dob})</p>
                                <p><strong>Provider:</strong> ${match.provider_name || 'N/A'}</p>
                                <p><strong>DOS:</strong> ${match.DOS_list.join(', ') || 'N/A'}</p>
                                <p><strong>CPTs:</strong><br>${match.CPTs.map((cpt, i) => `${cpt} - ${match.CPT_descriptions[i] || 'No description available'}`).join('<br>')}</p>
                                <button class="btn btn-success btn-sm mt-2" onclick="assignMapping('${match.order_id}')">
                                    Assign This Order
                                </button>
                            </div>
                        `;
                        matchesList.appendChild(card);
                    });
                }
            } else {
                // Display error in the results area instead of an alert
                const errorMsg = `<div class="alert alert-danger">
                    <h5>Error</h5>
                    <p>${data.error}</p>
                    <p class="mb-0 small">${data.details || ''}</p>
                </div>`;
                matchesList.innerHTML = errorMsg;
                matchCounter.textContent = 'Error';
                console.error('Search Error:', data.error, data.details);
            }
        } catch (error) {
            // Display error in the results area
            const errorMsg = `<div class="alert alert-danger">
                <h5>Search Failed</h5>
                <p>An error occurred while searching.</p>
                <p class="mb-0 small">${error.message}</p>
            </div>`;
            matchesList.innerHTML = errorMsg;
            matchCounter.textContent = 'Error';
            console.error('Search Error:', error);
        } finally {
            // Reset button state
            searchButton.disabled = false;
            searchButton.innerHTML = originalButtonText;
        }
    });
});

/**
 * Function to perform automatic search if conditions are met
 */
function performAutoSearch() {
    const autosearchToggle = document.getElementById('autosearchToggle');
    const lastNameField = document.getElementById('last-name-search');
    const firstNameField = document.getElementById('first-name-search');
    const dosSearchField = document.getElementById('dos-search');
    const searchButton = document.getElementById('search-button');
    const searchResults = document.getElementById('search-results');
    const matchesList = document.getElementById('matches-list');
    
    // Return early if required elements are missing
    if (!autosearchToggle || !lastNameField || !firstNameField || !dosSearchField || !searchButton || !searchResults || !matchesList) {
        console.log('Required elements for auto-search not found');
        return;
    }
    
    // Only proceed if auto-search is enabled
    if (!autosearchToggle.checked) {
        console.log('Auto-search is disabled');
        return;
    }
    
    // Check if last name field has a value (now the only required field)
    if (!lastNameField.value.trim()) {
        console.log('Last name is required for auto-search');
        return;
    }
    
    // Show search results with loading indicator
    searchResults.style.display = 'block';
    const loadingSpinner = document.getElementById('loading-spinner-template').content.cloneNode(true);
    matchesList.innerHTML = '';
    matchesList.appendChild(loadingSpinner);
    
    // Trigger search after a short delay
    console.log('Auto-search will execute in 500ms');
    setTimeout(() => {
        searchButton.click();
    }, 500);
}

/**
 * Helper function to clean and normalize last names
 * - Removes leading/trailing whitespace
 * - Removes non-alphanumeric characters except hyphens
 * - Handles edge cases
 */
function cleanLastName(lastName) {
    if (!lastName) return '';
    
    // Trim whitespace
    lastName = lastName.trim();
    
    // Remove common suffixes
    const suffixes = [' JR', ' SR', ' II', ' III', ' IV', ' V', ' MD', ' PHD', ' ESQ', ' JR.', ' SR.'];
    suffixes.forEach(suffix => {
        if (lastName.toUpperCase().endsWith(suffix)) {
            lastName = lastName.slice(0, lastName.length - suffix.length).trim();
        }
    });
    
    // Keep only alphanumeric characters and hyphens
    lastName = lastName.replace(/[^\w\s-]/g, '');
    
    return lastName.trim();
}

/**
 * Function to extract last name from full name with various formats
 */
function extractLastName(fullName) {
    if (!fullName || typeof fullName !== 'string') {
        console.log('Invalid name format provided');
        return '';
    }
    
    // Debug info
    console.log('Original patient name:', fullName);
    
    try {
        let lastName = '';
        fullName = fullName.trim();
        
        // Format: "Last, First"
        if (fullName.includes(',')) {
            lastName = fullName.split(',')[0].trim();
        }
        // Format with suffix: "John Smith Jr." or "John Smith Sr."
        else if (/\s(Jr\.?|Sr\.?|I{2,3}|IV|V|MD|PhD|Esq\.?)$/i.test(fullName)) {
            // Remove the suffix and then get the last word
            const nameWithoutSuffix = fullName.replace(/\s(Jr\.?|Sr\.?|I{2,3}|IV|V|MD|PhD|Esq\.?)$/i, '');
            const parts = nameWithoutSuffix.split(/\s+/);
            lastName = parts[parts.length - 1];
        }
        // Format with hyphenated last name: "Mary Johnson-Smith"
        else if (fullName.includes('-')) {
            const parts = fullName.split(/\s+/);
            // Check if the hyphen is in the last part
            if (parts[parts.length - 1].includes('-')) {
                lastName = parts[parts.length - 1];
            } 
            // Check if the hyphen is in the second-to-last part
            else if (parts.length > 1 && parts[parts.length - 2].includes('-')) {
                lastName = parts[parts.length - 2] + ' ' + parts[parts.length - 1];
            }
            // Otherwise just use the last word
            else {
                lastName = parts[parts.length - 1];
            }
        }
        // Format with multi-part last name: "Juan De La Cruz"
        else if (fullName.toLowerCase().includes(' de ') || 
                 fullName.toLowerCase().includes(' van ') || 
                 fullName.toLowerCase().includes(' von ') || 
                 fullName.toLowerCase().includes(' la ') ||
                 fullName.toLowerCase().includes(' du ')) {
            const parts = fullName.split(/\s+/);
            // If we have more than 2 words and the second to last is a known prefix
            if (parts.length > 2) {
                const possiblePrefix = parts[parts.length - 2].toLowerCase();
                if (['de', 'van', 'von', 'la', 'du', 'del', 'dos', 'di', 'el', 'al'].includes(possiblePrefix)) {
                    // Include the prefix and the last word
                    lastName = parts[parts.length - 2] + ' ' + parts[parts.length - 1];
                    
                    // Check for 3-part last names (e.g., "De La Cruz")
                    if (parts.length > 3) {
                        const previousPart = parts[parts.length - 3].toLowerCase();
                        if (['de', 'van', 'von', 'la', 'du', 'del'].includes(previousPart)) {
                            lastName = parts[parts.length - 3] + ' ' + lastName;
                        }
                    }
                } else {
                    lastName = parts[parts.length - 1];
                }
            } else {
                lastName = parts[parts.length - 1];
            }
        }
        // Default format: "First Last"
        else {
            const parts = fullName.split(/\s+/);
            lastName = parts[parts.length - 1];
        }
        
        // Clean and normalize the last name
        lastName = cleanLastName(lastName);
        
        // Debug info
        console.log('Extracted last name:', lastName);
        
        return lastName;
    } catch (error) {
        console.error('Error extracting last name:', error);
        return '';
    }
}

/**
 * Function to prepopulate the search fields based on patient information and service date
 */
function prepopulateSearchFields() {
    // Only proceed if required fields exist
    const patientNameField = document.querySelector('input[name="patient_info[patient_name]"]');
    const lastNameField = document.getElementById('last-name-search');
    const firstNameField = document.getElementById('first-name-search');
    const dosSearchField = document.getElementById('dos-search');
    
    if (!patientNameField || !lastNameField || !firstNameField || !dosSearchField) {
        console.log('Required fields not found for prepopulation');
        return;
    }
    
    // Extract patient last name only
    try {
        const patientFullName = patientNameField.value.trim();
        
        if (patientFullName) {
            // Extract and set the last name using the enhanced function
            const lastName = extractLastName(patientFullName);
            
            if (lastName) {
                // Set only the last name field
                lastNameField.value = lastName;
            } else {
                console.log('Could not extract a valid last name from:', patientFullName);
                lastNameField.value = ''; // Ensure the field is cleared if extraction failed
            }
            
            // Explicitly clear the first name field
            firstNameField.value = '';
        } else {
            console.log('No patient name found to extract last name from');
        }
    } catch (error) {
        console.error('Error in prepopulateSearchFields:', error);
        // Clear fields on error for safety
        lastNameField.value = '';
        firstNameField.value = '';
    }
    
    // Explicitly clear the date of service field
    dosSearchField.value = '';
    
    // Run auto-search after field is populated (only if last name has a value)
    if (lastNameField.value.trim()) {
        performAutoSearch();
    }
}

// Assign mapping function
function assignMapping(orderId) {
    console.log(`[DEBUG] Starting assignment for order: ${orderId}`);
    
    // Prevent multiple submissions
    const buttons = document.querySelectorAll(`button[onclick*="assignMapping('${orderId}')"]`);
    buttons.forEach(btn => {
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Assigning...';
    });
    
    // Create a loading toast and store its reference
    const loadingToast = showToast("Assigning order...", "info");
    
    // Track request time for debugging
    const requestStartTime = new Date();
    
    fetch(`/preprocessing/unmapped/{{ filename }}/assign`, {
        method: "POST",
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ order_id: orderId })
    })
    .then(res => {
        console.log(`[DEBUG] Response received in ${new Date() - requestStartTime}ms with status: ${res.status}`);
        
        // First handle specific HTTP error codes with custom messages
        if (!res.ok) {
            if (res.status === 404) {
                throw new Error("File not found. It may have been moved or deleted.");
            } else if (res.status === 403) {
                throw new Error("Permission denied. You don't have access to assign this file.");
            } else if (res.status === 500) {
                throw new Error("Server error. The system encountered an internal error.");
            } else if (res.status === 429) {
                throw new Error("Too many requests. Please try again later.");
            }
            
            // Try to get more detailed error from response body
            return res.json().then(data => {
                console.error('[DEBUG] Error response body:', data);
                throw new Error(data.error || data.details || `Server error (${res.status}): ${res.statusText}`);
            }).catch(jsonError => {
                // If JSON parsing fails, throw the original HTTP error
                console.error('[DEBUG] Failed to parse error response as JSON:', jsonError);
                throw new Error(`Server error (${res.status}): ${res.statusText}`);
            });
        }
        
        return res.json();
    })
    .then(data => {
        console.log('[DEBUG] Assignment response data:', data);
        
        if (data.success) {
            // Hide the loading toast
            hideToast(loadingToast);
            
            // Show success message and navigate to next file
            const userMessage = data.user_message || 'File has been successfully assigned.';
            navigateToNextFile(userMessage, "success");
        } else {
            // Handle case where response is OK but success flag is false
            console.error('[DEBUG] Server indicated failure:', data);
            throw new Error(data.error || data.details || "Unknown error occurred");
        }
    })
    .catch(error => {
        // Log the full error for debugging
        console.error('[DEBUG] Assignment error:', error);
        
        // Hide the loading toast
        hideToast(loadingToast);
        
        // Re-enable buttons
        buttons.forEach(btn => {
            btn.disabled = false;
            btn.innerHTML = 'Assign This Order';
        });
        
        // Create retry button
        const retryButton = `<button onclick="assignMapping('${orderId}')" class="btn btn-sm btn-primary mt-2">Retry</button>`;
        
        // Show error toast with retry option
        showToast(` Failed to assign: ${error.message}<br>${retryButton}`, "error", 0); // 0 means don't auto-hide
        
        // Optionally, add a visual indicator on the UI that assignment failed
        const orderElements = document.querySelectorAll(`[data-order-id="${orderId}"]`);
        orderElements.forEach(el => {
            el.classList.add('assignment-failed');
        });
    });
}

/**
 * Show a toast notification to the user
 * @param {string} message - Message to display
 * @param {string} type - Type of toast: "success", "error", "info", "warning"
 * @param {number} duration - Time in ms to show toast, 0 for no auto-hide
 * @returns {Object} Toast reference for later manipulation
 */
function showToast(message, type = "info", duration = 3000) {
    // Create toast container if it doesn't exist
    let toastContainer = document.getElementById("toast-container");
    if (!toastContainer) {
        toastContainer = document.createElement("div");
        toastContainer.id = "toast-container";
        toastContainer.className = "position-fixed bottom-0 end-0 p-3";
        toastContainer.style.zIndex = "5000";
        document.body.appendChild(toastContainer);
    }
    
    // Create toast element
    const toastId = `toast-${Date.now()}`;
    const toast = document.createElement("div");
    toast.id = toastId;
    toast.className = `toast show ${type}-toast`;
    toast.setAttribute("role", "alert");
    toast.setAttribute("aria-live", "assertive");
    toast.setAttribute("aria-atomic", "true");
    
    // Set background color based on type
    let bgClass = "bg-info text-white";
    if (type === "success") bgClass = "bg-success text-white";
    if (type === "error") bgClass = "bg-danger text-white";
    if (type === "warning") bgClass = "bg-warning text-dark";
    
    toast.innerHTML = `
        <div class="toast-header ${bgClass}">
            <strong class="me-auto">Bill Review Portal</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close" 
                    onclick="hideToast('${toastId}')"></button>
        </div>
        <div class="toast-body">
            ${message}
        </div>
    `;
    
    // Add to container
    toastContainer.appendChild(toast);
    
    // Auto-hide toast after duration if not 0
    let timeoutId;
    if (duration > 0) {
        timeoutId = setTimeout(() => {
            hideToast(toastId);
        }, duration);
    }
    
    // Return reference for later manipulation
    return {
        id: toastId,
        element: toast,
        timeoutId: timeoutId
    };
}

/**
 * Hide a toast notification
 * @param {string|Object} toast - Toast ID or toast reference object
 */
function hideToast(toast) {
    if (!toast) return;
    
    const toastId = typeof toast === 'string' ? toast : toast.id;
    const toastElement = document.getElementById(toastId);
    
    if (toastElement) {
        // Clear any existing timeout
        if (typeof toast === 'object' && toast.timeoutId) {
            clearTimeout(toast.timeoutId);
        }
        
        // Add fade-out effect
        toastElement.classList.remove("show");
        
        // Remove after animation completes
        setTimeout(() => {
            if (toastElement && toastElement.parentNode) {
                toastElement.parentNode.removeChild(toastElement);
            }
        }, 500);
    }
}
</script>
{% endblock %} 